<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CRM-Ticket • Tickets</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#0b0b0b;color:#eaeaea;font-family:Inter,system-ui,Roboto,Arial;margin:0;padding:20px;}
    .card{background:#0f0f0f;border:1px solid #222;padding:14px;border-radius:10px;}
    .muted{color:#bdbdbd}
    .status-pill{padding:6px 10px;border-radius:8px;font-weight:700}
    .status-pending{background:rgba(255,198,98,0.06);color:#ffc27a}
    .status-inprogress{background:rgba(98,163,255,0.06);color:#9ecbff}
    .status-completed{background:rgba(60,180,90,0.06);color:#8cf7a6}
    .status-onhold{background:rgba(200,200,200,0.03);color:#ccc}
    .table tbody tr td{vertical-align:middle}
    .small-muted{color:#9aa0a6;font-size:13px}
  </style>
</head>
<body>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 style="color:#ff64b1be;margin:0">CRM • Tickets</h3>
      <div class="small-muted">Tickets you created or that are assigned to you</div>
    </div>
    <div class="d-flex gap-2">
      <input id="q" class="form-control form-control-sm" placeholder="Search title, description, user..." style="width:300px" />
      <button id="btnNew" class="btn btn-danger btn-sm">+ New</button>
      <button id="btnLogout" class="btn btn-outline-light btn-sm">Logout</button>
    </div>
  </div>

  <div class="card mb-3">
    <div class="table-responsive">
      <table class="table table-dark table-hover mb-0">
        <thead>
          <tr class="text-muted">
            <th style="width:70px">id</th>
            <th>Title / Description</th>
            <th style="width:120px">Status</th>
            <th style="width:160px">Author</th>
            <th style="width:160px">Assignee</th>
            <th style="width:220px">Actions</th>
          </tr>
        </thead>
        <tbody id="ticketTable">
          <tr><td colspan="6" class="text-center muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="msg" class="text-center muted"></div>
</div>



<div class="modal fade" id="modalSave" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="background:#0e0e0e;color:#eee;border:1px solid #222">
      <div class="modal-header">
        <h5 id="modalTitle" class="modal-title">New Ticket</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="formSave" class="modal-body">
        <input type="hidden" name="id" id="ticketId" />
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input name="title" id="title" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" id="description" rows="6" class="form-control" required></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">File (optional)</label>
          <input type="file" name="file" id="file" class="form-control" />
          <div class="small-muted">Allowed: any file (stored in storage/uploads)</div>
        </div>
        <div class="d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" id="saveBtn" class="btn btn-danger">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>



<div class="modal fade" id="modalView" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="background:#0e0e0e;color:#eee;border:1px solid #222">
      <div class="modal-header">
        <h5 id="viewTitle" class="modal-title">View Ticket</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="viewBody">
       
      </div>
    </div>
  </div>
</div>



<div class="modal fade" id="modalAssign" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content" style="background:#0e0e0e;color:#eee;border:1px solid #222">
      <div class="modal-header">
        <h5 class="modal-title">Assign Ticket</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="formAssign" class="modal-body">
        <input type="hidden" id="assignTicketId" />
        <div class="mb-3">
          <label class="form-label">Assign to (user id)</label>
          <input id="assignTo" class="form-control" type="number" min="1" />
          <div class="small-muted">Provide user id (use admin users list or UI to pick)</div>
        </div>
        <div class="d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Assign</button>
        </div>
      </form>
    </div>
  </div>
</div>


<div class="modal fade" id="modalStatus" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content" style="background:#0e0e0e;color:#eee;border:1px solid #222">
      <div class="modal-header">
        <h5 class="modal-title">Change Status</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="formStatus" class="modal-body">
        <input type="hidden" id="statusTicketId" />
        <div class="mb-3">
          <label class="form-label">Status</label>
          <select id="statusSelect" class="form-control">
            <option value="pending">pending</option>
            <option value="inprogress">inprogress</option>
            <option value="completed">completed</option>
            <option value="onhold">onhold</option>
          </select>
        </div>
        <div class="d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE = location.pathname.includes('/app/') ? '../api/tickets.php' : 'api/tickets.php';
const ticketTable = document.getElementById('ticketTable');
const qEl = document.getElementById('q');
const msgEl = document.getElementById('msg');

const modalSave = new bootstrap.Modal(document.getElementById('modalSave'));
const modalView = new bootstrap.Modal(document.getElementById('modalView'));
const modalAssign = new bootstrap.Modal(document.getElementById('modalAssign'));
const modalStatus = new bootstrap.Modal(document.getElementById('modalStatus'));

document.getElementById('btnNew').addEventListener('click', openCreate);
document.getElementById('btnLogout').addEventListener('click', () => { window.location.href='login.html'; });
qEl.addEventListener('input', debounce(loadTickets, 400));

document.getElementById('formSave').addEventListener('submit', async function(e){
  e.preventDefault();
  await submitSave();
});

document.getElementById('formAssign').addEventListener('submit', async function(e){
  e.preventDefault();
  await submitAssign();
});

document.getElementById('formStatus').addEventListener('submit', async function(e){
  e.preventDefault();
  await submitStatus();
});

let saveBtn = document.getElementById('saveBtn');

function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms)} }

function statusClass(s){
  if(!s) return 'status-pending';
  if(s==='inprogress') return 'status-inprogress';
  if(s==='completed') return 'status-completed';
  if(s==='onhold') return 'status-onhold';
  return 'status-pending';
}

async function loadTickets(){
  msgEl.textContent = '';
  const q = qEl.value.trim();
  const url = API_BASE + (q ? '?q=' + encodeURIComponent(q) : '');
  try {
    const resp = await fetch(url, { credentials:'include' });
    const text = await resp.text();
    let json = null;
    try { json = JSON.parse(text); } catch(e){ console.error('Non-JSON', text); msgEl.textContent='Server error'; return; }
    if (!resp.ok) { msgEl.textContent = json.error || 'Failed to load'; return; }
    const tickets = json.tickets || [];
    ticketTable.innerHTML = '';
    if (!tickets.length) { ticketTable.innerHTML = '<tr><td colspan="6" class="text-center muted">No tickets found</td></tr>'; return; }
    tickets.forEach(t => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>#${t.id}</td>
        <td>
          <div style="font-weight:700">${escapeHtml(t.title)}</div>
          <div class="muted" style="font-size:13px">${escapeHtml((t.description||'').slice(0,140))}${(t.description?.length>140)?'...':''}</div>
        </td>
        <td><span class="status-pill ${statusClass(t.status)}">${escapeHtml(t.status||'pending')}</span></td>
        <td>${escapeHtml(t.author_name||'')}</td>
        <td>${escapeHtml(t.assignee_name||'-')}</td>
        <td>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-light" onclick="viewTicket(${t.id})">View</button>
            <button class="btn btn-sm btn-primary" onclick="openEdit(${t.id})">Edit</button>
            <button class="btn btn-sm btn-warning" onclick="openAssign(${t.id})">Assign</button>
            <button class="btn btn-sm btn-secondary" onclick="openStatus(${t.id},'${t.status||'pending'}')">Status</button>
            <button class="btn btn-sm btn-danger" onclick="deleteTicket(${t.id})">Delete</button>
          </div>
        </td>`;
      ticketTable.appendChild(tr);
    });
  } catch(err){ console.error(err); msgEl.textContent='Network error'; }
}

function escapeHtml(s){ return s? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }

function openCreate(){
  document.getElementById('modalTitle').textContent = 'New Ticket';
  document.getElementById('ticketId').value = '';
  document.getElementById('title').value = '';
  document.getElementById('description').value = '';
  document.getElementById('file').value = '';
  saveBtn.textContent = 'Create';
  modalSave.show();
}

async function openEdit(id){
  try {
    const resp = await fetch(API_BASE + '?id=' + id, { credentials:'include' });
    const json = await resp.json();
    if (!resp.ok) { alert(json.error || 'Cannot fetch ticket'); return; }
    const t = json.ticket;
    document.getElementById('modalTitle').textContent = 'Edit Ticket #' + t.id;
    document.getElementById('ticketId').value = t.id;
    document.getElementById('title').value = t.name || t.title || '';
    document.getElementById('description').value = t.description || '';
    document.getElementById('file').value = '';
    saveBtn.textContent = 'Update';
    modalSave.show();
  } catch(err){ console.error(err); alert('Network error'); }
}

async function submitSave(){
  const id = document.getElementById('ticketId').value || '';
  const fd = new FormData();
  if (id) fd.append('id', id);
  fd.append('title', document.getElementById('title').value.trim());
  fd.append('description', document.getElementById('description').value.trim());
  const f = document.getElementById('file').files[0];
  if (f) fd.append('file', f);

  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';
  try {
    const resp = await fetch(API_BASE + (id ? '' : ''), { method:'POST', credentials:'include', body: fd });
    const json = await resp.json();
    if (!resp.ok) { alert(json.error || 'Save failed'); return; }
    modalSave.hide();
    loadTickets();
  } catch(err){ console.error(err); alert('Network error'); }
  finally { saveBtn.disabled = false; saveBtn.textContent = id ? 'Update' : 'Create'; }
}

async function viewTicket(id){
  try {
    const resp = await fetch(API_BASE + '?id=' + id, { credentials:'include' });
    const json = await resp.json();
    if (!resp.ok) { alert(json.error || 'Cannot fetch'); return; }
    const t = json.ticket;
    const body = document.getElementById('viewBody');
    let html = `<h5 style="color:#ff6464">#${t.id} - ${escapeHtml(t.name||t.title||'')}</h5>`;
    html += `<p class="small-muted">By ${escapeHtml(t.author_name||'')} • ${t.created_at || ''}</p>`;
    html += `<div style="margin-top:10px">${escapeHtml(t.description||'')}</div>`;
    if (t.file_path) {
      html += `<div style="margin-top:10px">File: <a class="link-light" href="../../${escapeHtml(t.file_path)}" target="_blank">Download</a></div>`;
    }
    html += `<div style="margin-top:12px" class="small-muted">Status: ${escapeHtml(t.status||'pending')}</div>`;
    if (t.assignee) html += `<div class="small-muted">Assignee: ${escapeHtml(t.assignee.name)}</div>`;
    body.innerHTML = html;
    modalView.show();
  } catch(err){ console.error(err); alert('Network error'); }
}

function openAssign(id){
  document.getElementById('assignTicketId').value = id;
  document.getElementById('assignTo').value = '';
  modalAssign.show();
}

async function submitAssign(){
  const ticket_id = document.getElementById('assignTicketId').value;
  const assigned_to = document.getElementById('assignTo').value;
  if (!assigned_to) { alert('Enter user id'); return; }
  try {
    const fd = new FormData();
    fd.append('ticket_id', ticket_id);
    fd.append('assigned_to', assigned_to);
    const resp = await fetch(API_BASE + '?action=assign', { method:'POST', credentials:'include', body: fd });
    const json = await resp.json();
    if (!resp.ok) { alert(json.error || 'Assign failed'); return; }
    modalAssign.hide();
    loadTickets();
  } catch(err){ console.error(err); alert('Network error'); }
}

function openStatus(id, current){
  document.getElementById('statusTicketId').value = id;
  document.getElementById('statusSelect').value = current || 'pending';
  modalStatus.show();
}

async function submitStatus(){
  const id = document.getElementById('statusTicketId').value;
  const status = document.getElementById('statusSelect').value;
  try {
    const fd = new FormData();
    fd.append('id', id);
    fd.append('status', status);
    const resp = await fetch(API_BASE + '?action=status', { method:'POST', credentials:'include', body: fd });
    const json = await resp.json();
    if (!resp.ok) { alert(json.error || 'Status update failed'); return; }
    modalStatus.hide();
    loadTickets();
  } catch(err){ console.error(err); alert('Network error'); }
}

async function deleteTicket(id){
  if (!confirm('Delete ticket?')) return;
  try {
    // use POST?action=delete for compatibility
    const fd = new FormData();
    fd.append('id', id);
    const resp = await fetch(API_BASE + '?action=delete', { method:'POST', credentials:'include', body: fd });
    const json = await resp.json();
    if (!resp.ok) { alert(json.error || 'Delete failed'); return; }
    loadTickets();
  } catch(err){ console.error(err); alert('Network error'); }
}

// initial load
loadTickets();
</script>

</body>
</html>
