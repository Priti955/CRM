<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>CRM-Ticket - User Management</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- Enhanced Variables for Modern Dark Theme --- */
        :root {
            --bg: #0d1117;
            /* GitHub Dark Background */
            --card: #161b22;
            /* Slightly Lighter Card/Panel */
            --border: #30363d;
            /* Soft Border Color */
            --muted: #8b949e;
            /* Soft Muted Text */
            --accent: #2c97ff;
            /* Primary Action Color (Blue) */
            --accent-grad: linear-gradient(180deg, #58a6ff, #2c97ff);
            /* Soft Blue Gradient */
            --danger: #f85149;
            --success: #3fb950;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: #c9d1d9;
            /* Light text */
            font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
            transition: background 0.3s;
        }

        /* --- Layout & Structure --- */
        .container-xl {
            max-width: 1200px;
            padding: 30px 24px;
            margin: 0 auto;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 25px;
        }

        .title {
            color: var(--accent);
            font-weight: 700;
            letter-spacing: 0.5px;
            font-size: 1.8rem;
        }

        .muted {
            color: var(--muted);
        }

        /* --- Card & Components --- */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            /* Subtle Shadow */
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Form Controls */
        .form-control,
        .modal-content select {
            background: #0d1117 !important;
            /* Deeper background for inputs */
            border: 1px solid var(--border) !important;
            color: #eee !important;
            border-radius: 6px !important;
            padding: 10px 12px !important;
            box-shadow: none !important;
        }

        .form-control::placeholder {
            color: var(--muted);
        }

        /* Buttons */
        .btn-primary {
            background: var(--accent-grad);
            border: none;
            color: #0d1117 !important;
            font-weight: 600;
            padding: 8px 15px;
            border-radius: 6px;
            transition: transform 0.1s;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-outline-light {
            border-color: var(--border) !important;
            color: var(--muted) !important;
            transition: background 0.2s, color 0.2s;
        }

        .btn-outline-light:hover {
            background: var(--border) !important;
            color: #fff !important;
        }

        /* --- Table Styling --- */
        .table {
            --bs-table-bg: var(--card);
            --bs-table-color: #c9d1d9;
            border-collapse: separate;
            border-spacing: 0;
        }

        .table thead th {
            color: var(--accent);
            font-weight: 600;
            border-bottom: 2px solid var(--accent);
            /* Thicker accent line */
            padding-bottom: 12px;
            vertical-align: middle;
        }

        .table tbody td {
            border-bottom: 1px solid var(--border);
            padding: 12px 0;
            vertical-align: middle;
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Badges */
        .role-badge {
            padding: 4px 10px;
            border-radius: 50px;
            /* Pill shape */
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        /* Status colors for visibility */
        .status-active {
            color: var(--success);
            background: rgba(63, 185, 80, 0.1);
            border: 1px solid var(--success);
        }

        .status-inactive {
            color: var(--danger);
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid var(--danger);
        }

        /* Modal Overrides */
        .modal-content {
            background: var(--card) !important;
            border: 1px solid var(--border) !important;
            border-radius: 12px !important;
        }

        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
            /* Make close button visible on dark */
        }

        /* Responsive */
        @media (max-width: 900px) {
            .topbar {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .topbar>div:last-child {
                flex-wrap: wrap;
            }

            .search-input {
                flex-grow: 1;
            }
        }
    </style>
</head>

<body>

    <div class="container-xl">
        <div class="topbar">
            <div>
                <div class="title"><i class="fas fa-users-cog me-2"></i> CRM-TICKET • Users</div>
                <div class="muted" style="font-size:13px">Centralized management for application users and access roles.</div>
            </div>

            <div style="display:flex;gap:10px;align-items:center">
                <div class="search-input">
                    <input id="q" class="form-control" placeholder="Search name or email..." oninput="loadUsers()">
                </div>
                <button class="btn btn-primary" id="btnNew" onclick="openCreate()">
                    <i class="fas fa-user-plus me-1"></i> New User
                </button>
                <button class="btn btn-outline-light" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                <h3 style="font-weight:600;color:#fff; font-size: 1.25rem;">User Directory</h3>
                <div class="muted">Total users: <span id="userCount">...</span></div>
            </div>

            <div class="table-responsive">
                <table class="table table-borderless text-white">
                    <thead>
                        <tr>
                            <th style="width:70px">ID</th>
                            <th>Name</th>
                            <th style="width:280px">Email</th>
                            <th style="width:140px">Role</th>
                            <th style="width:140px">Status</th>
                            <th style="width:300px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>
        </div>

        <div id="message" class="muted" style="text-align:center;margin-top:20px; font-style: italic;"></div>
    </div>


    <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Create User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="userForm" class="modal-body">
                    <input type="hidden" id="userId">

                    <div class="mb-3">
                        <label class="form-label muted">Full name</label>
                        <input id="userName" class="form-control">
                        <div class="error-msg" id="userNameErr"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label muted">Email</label>
                        <input id="userEmail" class="form-control">
                        <div class="error-msg" id="userEmailErr"></div>
                    </div>

                    <div class="mb-3" id="passwordRow">
                        <label class="form-label muted">Password</label>
                        <input id="userPassword" type="password" class="form-control">
                        <div class="error-msg" id="userPasswordErr"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label muted">Role</label>
                        <select id="userRole" class="form-control">
                            <option value="user">User (Standard)</option>
                            <option value="admin">Admin (Manager)</option>
                        </select>
                        <div class="error-msg" id="userRoleErr"></div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 pt-3">
                        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="userSaveBtn">
                            <i class="fas fa-save me-1"></i> Save User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Action</h5>
                </div>
                <div class="modal-body">
                    <div id="confirmText">Are you sure?</div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary btn-danger" id="confirmOkBtn"
                        style="background: var(--danger); color: white!important;">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- API ENDPOINTS (Updated for consistency with users.php backend) ---
        const API_LIST = '../api/users.php';
        const API_SAVE = '../api/users.php?action=save'; 
        const API_STATUS = '../api/users.php?action=status'; 
        const API_DELETE = '../api/users.php?action=delete'; 

        const usersTable = document.getElementById('usersTable');
        const userCountEl = document.getElementById('userCount'); 
        const qInput = document.getElementById('q');
        const messageEl = document.getElementById('message');

        const userModal = new bootstrap.Modal(document.getElementById('userModal'));
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

        let _users = [];

        document.addEventListener('DOMContentLoaded', loadUsers);

        async function loadUsers() {
            messageEl.textContent = 'Loading...';
            userCountEl.textContent = '...';
            const q = qInput.value.trim();
            // Note: The backend logic provided doesn't handle 'q', but we keep it structured.
            const url = API_LIST + (q ? '?q=' + encodeURIComponent(q) : ''); 

            try {
                const resp = await fetch(url, { credentials: 'include' });

                let json = null;
                try { json = await resp.json(); }
                catch { json = null; }

                if (resp.status === 401 || (json && json.error === "Not logged in")) {
                    window.location.href = 'login.html';
                    return;
                }

                if (resp.status === 403) {
                    messageEl.textContent = 'Access denied — admin only';
                    usersTable.innerHTML = '<tr><td colspan="6" class="text-center muted pt-5 pb-5">You do not have permission to view the User Directory.</td></tr>';
                    userCountEl.textContent = '0';
                    return;
                }

                if (!resp.ok || !json || !json.success) {
                    messageEl.textContent = json?.error || 'Failed to load users';
                    usersTable.innerHTML = '<tr><td colspan="6" class="text-center muted">Failed to load data.</td></tr>';
                    userCountEl.textContent = '0';
                    return;
                }

                _users = json.users || [];
                renderTable(_users);
                messageEl.textContent = '';

            } catch (err) {
                console.error(err);
                messageEl.textContent = 'Network error while loading users.';
            }
        }

        function renderTable(users) {
            usersTable.innerHTML = '';
            userCountEl.textContent = users.length;

            if (!users.length) {
                usersTable.innerHTML = `<tr><td colspan="6" class="text-center muted pt-5 pb-5">No users found matching the search criteria.</td></tr>`;
                return;
            }

            const roleColors = {
                admin: "#ff4b4b", // Red-ish for high access
                user: "#647bff", // Blue-ish for standard access
                staff: "#3fb950" // Green-ish for staff (if applicable)
            };

            function renderActions(user) {
                const editBtn = `<button class="btn btn-sm btn-outline-light" onclick="openEdit(${user.id})"><i class="fas fa-edit"></i> Edit</button>`;
                
                // Status Button (Deactivate or Reactivate)
                const statusBtn = user.is_active
                    ? `<button class="btn btn-sm btn-danger" onclick="confirmAction('Deactivate user ${escapeHtml(user.email)}?', ()=>changeStatus(${user.id}, 0))"><i class="fas fa-user-times"></i> Deactivate</button>`
                    : `<button class="btn btn-sm btn-primary" onclick="confirmAction('Reactivate user ${escapeHtml(user.email)}?', ()=>changeStatus(${user.id}, 1))" style="background:var(--success);"><i class="fas fa-user-plus"></i> Reactivate</button>`;
                
                // Delete Button
                const deleteBtn = `<button class="btn btn-sm btn-outline-light" onclick="confirmAction('Permanently delete user ${escapeHtml(user.email)}? This cannot be undone.', ()=>deleteUser(${user.id}))" style="border-color:var(--danger);color:var(--danger) !important;"><i class="fas fa-trash"></i> Delete</button>`;

                return `<div style="display:flex;gap:8px">${editBtn}${statusBtn}${deleteBtn}</div>`;
            }

            users.forEach(u => {
                const statusText = u.is_active ? "Active" : "Inactive";
                const statusClass = u.is_active ? "status-active" : "status-inactive";

                const tr = document.createElement('tr');
                tr.innerHTML = `
					<td>#${u.id}</td>
					<td><b>${escapeHtml(u.name)}</b></td>
					<td>${escapeHtml(u.email)}</td>
					<td>
						<span class="role-badge" style="background-color: ${roleColors[u.role] || '#111'}; border: 1px solid ${roleColors[u.role] || '#fff'}1A;">
							${escapeHtml(u.role)}
						</span>
					</td>
					<td>
						<span class="${statusClass}">
							${statusText}
						</span>
					</td>
					<td>${renderActions(u)}</td>
				`;
                usersTable.appendChild(tr);
            });
        }


        function escapeHtml(s) {
            return String(s || "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }



        const userIdInput = document.getElementById('userId');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userPassword = document.getElementById('userPassword');
        const userRole = document.getElementById('userRole');

        const userNameErr = document.getElementById('userNameErr');
        const userEmailErr = document.getElementById('userEmailErr');
        const userPasswordErr = document.getElementById('userPasswordErr');
        const userRoleErr = document.getElementById('userRoleErr');

        function clearErrors() {
            [userNameErr, userEmailErr, userPasswordErr, userRoleErr]
                .forEach(e => e.style.display = 'none');
        }

        function openCreate() {
            clearErrors();
            userIdInput.value = "";
            userName.value = "";
            userEmail.value = "";
            userPassword.value = "";
            userRole.value = "user";
            userPassword.required = true;
            document.getElementById('passwordRow').style.display = 'block';

            document.getElementById('userModalTitle').textContent = "Create New User";
            document.getElementById('userSaveBtn').innerHTML = '<i class="fas fa-user-plus me-1"></i> Create User';
            userModal.show();
        }

        function openEdit(id) {
            clearErrors();
            const u = _users.find(x => x.id == id);
            if (!u) { alert("User not found"); return; }

            userIdInput.value = u.id;
            userName.value = u.name;
            userEmail.value = u.email;
            userRole.value = u.role;

            userPassword.value = "";
            userPassword.required = false;

            document.getElementById('passwordRow').style.display = 'block';

            document.getElementById('userModalTitle').textContent = `Edit User #${u.id}`;
            document.getElementById('userSaveBtn').innerHTML = '<i class="fas fa-save me-1"></i> Save Changes';
            userModal.show();
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrors();

            const id = userIdInput.value;
            const name = userName.value.trim();
            const email = userEmail.value.trim();
            const password = userPassword.value.trim();
            const role = userRole.value;

            let valid = true;

            if (name.length < 2) {
                userNameErr.textContent = "Name required";
                userNameErr.style.display = 'block';
                valid = false;
            }
            if (!/^\S+@\S+\.\S+$/.test(email)) {
                userEmailErr.textContent = "Valid email required";
                userEmailErr.style.display = 'block';
                valid = false;
            }
            if (!id && password.length < 8) {
                userPasswordErr.textContent = "Password min 8 chars";
                userPasswordErr.style.display = 'block';
                valid = false;
            }
            if (!["user", "admin"].includes(role)) {
                userRoleErr.textContent = "Invalid role";
                userRoleErr.style.display = 'block';
                valid = false;
            }

            if (!valid) return;

            const payload = { id: id || 0, name, email, role };
            if (password) payload.password = password;

            // API_SAVE uses the action 'save' and handles both create (id=0) and update (id > 0)
            const apiUrl = API_SAVE; 

            try {
                const resp = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify(payload)
                });

                let json = null;
                try { json = await resp.json(); }
                catch { json = null; }

                if (resp.status === 401) {
                    window.location.href = 'login.html';
                    return;
                }

                if (!resp.ok || !json || !json.success) {
                    alert(json?.error || "Failed to save user");
                    console.error(json);
                    return;
                }

                userModal.hide();
                loadUsers();

            } catch (err) {
                console.error(err);
                alert("Network error");
            }
        });


        function confirmAction(text, callback) {
            document.getElementById('confirmText').textContent = text;
            document.getElementById('confirmOkBtn').onclick = () => {
                confirmModal.hide();
                callback();
            };
            confirmModal.show();
        }

        // --- CRUD: Update Status Handler ---
        async function changeStatus(id, newStatus) {
            try {
                const resp = await fetch(API_STATUS, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ id: id, is_active: newStatus })
                });

                let json = null;
                try { json = await resp.json(); }
                catch { json = null; }

                if (resp.status === 401) {
                    window.location.href = "login.html";
                    return;
                }

                if (!resp.ok || !json || !json.success) {
                    alert(json?.error || `Failed to change status to ${newStatus ? 'active' : 'inactive'}`);
                    return;
                }

                loadUsers();
            } catch (err) {
                console.error(err);
                alert("Network error changing status.");
            }
        }

        // --- CRUD: Delete Handler ---
        async function deleteUser(id) {
            try {
                const resp = await fetch(API_DELETE, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ id: id })
                });

                let json = null;
                try { json = await resp.json(); }
                catch { json = null; }

                if (resp.status === 401) {
                    window.location.href = "login.html";
                    return;
                }

                if (!resp.ok || !json || !json.success) {
                    alert(json?.error || "Failed to delete user");
                    return;
                }

                loadUsers();
            } catch (err) {
                console.error(err);
                alert("Network error deleting user.");
            }
        }


        async function logout() {
            try { await fetch('../api/auth.php?action=logout', { method: 'POST', credentials: 'include' }); }
            catch { }

            window.location.href = "login.html";
        }

    </script>
</body>

</html>